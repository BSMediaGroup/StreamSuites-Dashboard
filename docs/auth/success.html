<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    window.ADMIN_BASE_PATH = "/docs";
  </script>
  <meta charset="utf-8" />
  <title>StreamSuites Admin Login Successful</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="streamsuites-auth-base" content="https://api.streamsuites.app" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/overrides.css" />
  <link rel="stylesheet" href="../css/theme-dark.css" />
  <link rel="stylesheet" href="../css/updates.css" />

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }
    .admin-auth-card {
      max-width: 520px;
      text-align: center;
    }
    .admin-auth-status {
      margin-top: 12px;
    }
    .admin-auth-actions {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <main class="admin-auth-card glass-card">
    <h1>Admin login successful</h1>
    <p id="auth-success-message" class="muted">
      Verifying administrator session.
    </p>
    <div id="auth-success-status" class="admin-auth-status" role="status" aria-live="polite"></div>
    <div class="admin-auth-actions">
      <a id="auth-success-login" class="ss-btn ss-btn-secondary hidden" href="/docs/auth/login.html">
        Return to login
      </a>
    </div>
  </main>

  <script>
    (() => {
      const ADMIN_ORIGIN = window.location.origin;
      let basePath =
        typeof window.ADMIN_BASE_PATH === "string" ? window.ADMIN_BASE_PATH.trim() : "";
      basePath = basePath.replace(/\/+$/, "");
      if (basePath) {
        const pathname = window.location?.pathname || "";
        if (!(pathname === basePath || pathname.startsWith(`${basePath}/`))) {
          basePath = "";
        }
      }
      if (basePath !== window.ADMIN_BASE_PATH) {
        window.ADMIN_BASE_PATH = basePath;
      }

      const messageEl = document.getElementById("auth-success-message");
      const statusEl = document.getElementById("auth-success-status");
      const loginLink = document.getElementById("auth-success-login");

      const runtimeBase = (() => {
        const metaBase =
          document.querySelector('meta[name="streamsuites-auth-base"]')?.getAttribute("content") ||
          "";
        return typeof metaBase === "string" ? metaBase.trim().replace(/\/+$/, "") : "";
      })();

      const sessionEndpoint = runtimeBase ? `${runtimeBase}/auth/session` : "";
      const redirectTarget = new URL(`${basePath || ""}/`, ADMIN_ORIGIN).toString();

      function setStatus(state, message) {
        if (statusEl) {
          statusEl.dataset.state = state;
          statusEl.textContent = message || "";
        }
      }

      function showError(message) {
        if (messageEl) {
          messageEl.textContent = message;
        }
        setStatus("error", "Session could not be confirmed.");
        if (loginLink) {
          loginLink.classList.remove("hidden");
        }
      }

      function normalizeRole(payload) {
        if (!payload || typeof payload !== "object") return "";
        if (typeof payload.role === "string") return payload.role.trim().toLowerCase();
        if (typeof payload.user?.role === "string") return payload.user.role.trim().toLowerCase();
        return "";
      }

      async function confirmSession() {
        if (!sessionEndpoint) {
          showError("Session endpoint is not configured. Please sign in again.");
          return;
        }

        setStatus("loading", "Checking admin session.");

        try {
          const response = await fetch(sessionEndpoint, {
            method: "GET",
            credentials: "include",
            headers: {
              Accept: "application/json"
            },
            cache: "no-store"
          });

          if (!response.ok) {
            showError("Session check failed. Please sign in again.");
            return;
          }

          let payload = null;
          try {
            payload = await response.json();
          } catch (err) {
            showError("Session response was not readable. Please sign in again.");
            return;
          }

          const role = normalizeRole(payload);
          const sessionValid =
            payload?.ok === true ||
            payload?.authenticated === true ||
            payload?.session_valid === true;
          if (sessionValid && role === "admin") {
            setStatus("success", "Session confirmed. Redirecting to the dashboard.");
            window.location.assign(redirectTarget);
            return;
          }

          showError("Admin access was not confirmed for this session.");
        } catch (err) {
          showError("Unable to reach the authorization service. Please sign in again.");
        }
      }

      confirmSession();
    })();
  </script>
</body>
</html>
